<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mermaid C4 Editor</title>
</head>
<body>
  <textarea id="editor" style="width:100%;height:200px;">C4Context
Person(admin, "Admin")
C4System(bastion, "Bastion Host")
Relationship(admin, bastion, "SSH")
</textarea>
  <br/>
  <button id="render">Render</button>
  <button id="save">Save</button>
  <div id="diagram"></div>

  <script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    import mermaidC4 from 'https://unpkg.com/mermaid-c4-plugin@1.29.0/dist/index.esm.min.mjs';

    mermaid.initialize({ startOnLoad: false, theme: 'default', securityLevel: 'strict' });
    mermaid.use({ c4: mermaidC4 });

    const editor = document.getElementById('editor');
    const diagram = document.getElementById('diagram');
    const renderBtn = document.getElementById('render');
    const saveBtn = document.getElementById('save');

    renderBtn.addEventListener('click', () => {
      mermaid.render('generatedDiagram', editor.value).then(({ svg }) => {
        diagram.innerHTML = svg;
      });
    });

    /* FROM HERE */
saveBtn.addEventListener('click', async () => {
  let pw = localStorage.getItem('PASSWORD') || '';
  const attemptSave = async (password) => {
    const auth = btoa(`admin:${password}`);
    const resp = await fetch('/save', {
      method: 'POST',
      headers: {
        'Content-Type': 'text/plain',
        'Authorization': `Basic ${auth}`
      },
      body: editor.value
    });
    return resp;
  };

  let resp = await attemptSave(pw);
  if (resp.status === 401) {
    pw = prompt('Save failed, please enter password:');
    localStorage.setItem('PASSWORD', pw);
    resp = await attemptSave(pw);
  }

  alert(await resp.text());
});
/* TO HERE */
      alert(await resp.text());
    });
  </script>
</body>
</html>